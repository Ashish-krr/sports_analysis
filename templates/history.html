<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training History</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <style>
    :root{ --bg:#0a0f1f; --panel:#0f172a; --card:#0b1220; --muted:#94a3b8; --text:#e2e8f0; --brand:#22c55e; --accent:#60a5fa; --line:#1f2937; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: radial-gradient(1200px 600px at 70% -10%, rgba(34,197,94,.18), transparent), var(--bg); color: var(--text); }
    .nav { position: sticky; top: 0; z-index: 10; background: rgba(15,23,42,.85); backdrop-filter: blur(6px); border-bottom: 1px solid var(--line); }
    .nav-inner { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; letter-spacing: .3px; color: white; }
    .brand .logo { width: 28px; height: 28px; background: linear-gradient(135deg,var(--brand),#16a34a); border-radius: 8px; box-shadow: 0 0 20px rgba(34,197,94,.35) inset; }
    .brand a { color: #cbd5e1; text-decoration: none; font-weight: 600; }

    .container { max-width: 1100px; margin: 20px auto 60px; padding: 0 16px; }
    h1 { color: white; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    .card { background: var(--panel); border:1px solid var(--line); border-radius: 12px; padding: 14px; }
    .row { display:grid; grid-template-columns: 1fr 120px 120px 160px; gap: 10px; align-items:center; }
    .row strong { color:#93c5fd; }
    .muted { color: var(--muted); }
    .pill { display:inline-block; border:1px solid var(--line); background:#0b1220; color:#cbd5e1; padding:4px 10px; border-radius:999px; font-size:.85rem; }
    .subtle { font-size:.9rem; color:#cbd5e1; }
    .empty { color: var(--muted); padding: 20px; text-align: center; }
    .section { margin-top: 16px; }
    .chart-card { background: var(--panel); border:1px solid var(--line); border-radius: 12px; padding: 14px; }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand"><div class="logo"></div> RannNiti</div>
      <div class="brand"><a href="/">New Session</a></div>
    </div>
  </div>
  <div class="container">
    <h1>Training History</h1>
    <p class="muted">Review your recent exercise analyses and GPS speed runs.</p>

    <div class="section">
      <h2 class="subtle">Run Progress</h2>
      <div class="chart-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <span class="muted">Distance and average speed over time</span>
          <button id="seed_demo" style="padding:6px 10px; border-radius:8px; background:#22c55e; color:#0a0f1f; border:none; font-weight:700; cursor:pointer;">Load Demo Data</button>
        </div>
        <canvas id="runs_chart" height="130"></canvas>
      </div>
    </div>

    <div class="section">
      <h2 class="subtle">Exercise Sessions</h2>
      {% if sessions and sessions|length > 0 %}
      <div class="grid">
        {% for s in sessions %}
        <div class="card">
          <div class="row">
            <div>
              <div><strong>{{ s.exercise|capitalize }}</strong></div>
              <div class="muted">Session ID: {{ s.session_id[:8] }}...</div>
            </div>
            <div>Reps: <span class="pill">{{ s.total_reps }}</span></div>
            <div>Duration: <span class="pill">{{ '%.1f'|format(s.duration_s) }}s</span></div>
            <div class="muted">{{ s.created_at|int }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="card empty">No exercise sessions yet. Run an analysis to see it here.</div>
      {% endif %}
    </div>

    <div class="section">
      <h2 class="subtle">GPS Speed Runs (Local)</h2>
      <div id="gps_runs" class="grid"></div>
      <div id="gps_empty" class="card empty" style="display:none;">No GPS runs saved yet. Use Speed Test to record.</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // Load GPS runs from localStorage and render
    (function(){
      const el = document.getElementById('gps_runs');
      const empty = document.getElementById('gps_empty');
      let runs = [];
      try { runs = JSON.parse(localStorage.getItem('gps_runs') || '[]'); } catch(e) { runs = []; }
      if(!runs.length){ empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      runs.sort((a,b)=> (b.started_at||0) - (a.started_at||0));
      runs.slice(0,50).forEach(r => {
        const card = document.createElement('div');
        card.className = 'card';
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div>
            <div><strong>${r.title || 'Run'}</strong></div>
            <div class="muted">${new Date(r.started_at||Date.now()).toLocaleString()}</div>
          </div>
          <div>Distance: <span class="pill">${(r.distance_km||0).toFixed(2)} km</span></div>
          <div>Avg Speed: <span class="pill">${(r.avg_kmh||0).toFixed(1)} km/h</span></div>
          <div>Duration: <span class="pill">${(r.duration_s||0).toFixed(1)}s</span></div>
        `;
        card.appendChild(row);
        el.appendChild(card);
      });
    })();
    // Build chart from GPS runs (or demo data)
    (function(){
      const ctx = document.getElementById('runs_chart');
      if(!ctx) return;
      let runs = [];
      try { runs = JSON.parse(localStorage.getItem('gps_runs') || '[]'); } catch(e) { runs = []; }
      runs.sort((a,b)=> (a.started_at||0) - (b.started_at||0));

      let labels, dist, speed;
      if(runs.length){
        labels = runs.map(r => new Date(r.started_at||Date.now()).toLocaleDateString());
        dist = runs.map(r => (r.distance_km||0));
        speed = runs.map(r => (r.avg_kmh||0));
      } else {
        // Demo dataset if no runs
        labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        dist = [1.2, 2.0, 2.4, 3.1, 3.0, 3.6, 4.2];
        speed = [7.5, 8.2, 8.4, 8.8, 9.0, 9.3, 9.8];
      }

      try {
        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Distance (km)',
                data: dist,
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96,165,250,.2)',
                tension: .3,
                yAxisID: 'y1'
              },
              {
                label: 'Avg Speed (km/h)',
                data: speed,
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34,197,94,.2)',
                tension: .3,
                yAxisID: 'y2'
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: '#cbd5e1' } },
              tooltip: { mode: 'index', intersect: false }
            },
            interaction: { mode: 'index', intersect: false },
            scales: {
              x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,.15)' } },
              y1: { type: 'linear', position: 'left', ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,.1)' } },
              y2: { type: 'linear', position: 'right', ticks: { color: '#94a3b8' }, grid: { drawOnChartArea: false } }
            }
          }
        });
      } catch(e) {
        // no-op if chart fails
      }
    })();

    // Seed demo runs with increasing average speed
    (function(){
      const btn = document.getElementById('seed_demo');
      if(!btn) return;
      btn.addEventListener('click', () => {
        const now = Date.now();
        const baseSpeed = 7.0; // km/h starting
        const runs = [];
        for(let i=0;i<12;i++){
          const durationMin = 15 + i; // gradually longer
          const avgKmh = baseSpeed + i * 0.5; // increasing avg speed
          const distanceKm = (avgKmh * (durationMin/60));
          runs.push({
            title: `Demo Run ${i+1}`,
            started_at: now - (12 - i) * 86400000, // days ago
            duration_s: durationMin * 60,
            distance_km: distanceKm,
            avg_kmh: avgKmh
          });
        }
        // Merge with existing local runs
        let existing = [];
        try { existing = JSON.parse(localStorage.getItem('gps_runs') || '[]'); } catch(e) { existing = []; }
        localStorage.setItem('gps_runs', JSON.stringify(existing.concat(runs)));
        location.reload();
      });
    })();
  </script>
</body>
</html>


